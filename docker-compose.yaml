# docker-compose.yaml - bulletproof version for Airflow (Astro runtime) + Postgres + Streamlit
services:

  # Display service - shows access information
  display-info:
    image: alpine:latest
    container_name: display-info
    command: >
      sh -c "
      sleep 2;
      echo '';
      echo '=======================================================================';
      echo '          EXCHANGE RATE PIPELINE - ACCESS INFORMATION';
      echo '=======================================================================';
      echo '';
      echo '   AIRFLOW WEB UI:';
      echo '   URL:      http://localhost:8080';
      echo '   Username: admin';
      echo '   Password: admin123';
      echo '';
      echo '   STREAMLIT DASHBOARD:';
      echo '   URL:      http://localhost:8501';
      echo '   Username: streamlit_user';
      echo '   Password: streamlit123';
      echo '';
      echo '=======================================================================';
      echo '   QUICK START:';
      echo '   1. Open http://localhost:8080 and login to Airflow';
      echo '   2. Unpause and trigger your DAG';
      echo '   3. Wait for DAG to complete';
      echo '   4. Open http://localhost:8501 to view exchange rates';
      echo '';
      echo '   View this info anytime: docker-compose logs display-info';
      echo '=======================================================================';
      echo '';
      tail -f /dev/null;
      "
    restart: unless-stopped

  exchange-postgres:
    image: postgres:15
    container_name: exchange-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: exchanger
      POSTGRES_PASSWORD: exchanger
      POSTGRES_DB: exchange_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U exchanger -d exchange_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  # One-shot init service
  airflow-init:
    image: quay.io/astronomer/astro-runtime:11.3.0
    container_name: airflow-init
    depends_on:
      exchange-postgres:
        condition: service_healthy
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://exchanger:exchanger@exchange-postgres:5432/exchange_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "airflow_secret_key_change_in_prod"
      EXCHANGE_DB_URL: postgresql://exchanger:exchanger@exchange-postgres:5432/exchange_db
      # Admin credentials
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin123
      ADMIN_EMAIL: admin@exchange.com
    volumes:
      - ./dags:/usr/local/airflow/dags:ro
      - ./etl:/usr/local/airflow/dags/etl:ro
      - ./sql:/usr/local/airflow/dags/sql:ro
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -e
        echo "==================== AIRFLOW INIT ===================="
        
        # Wait for postgres
        until pg_isready -h exchange-postgres -U exchanger -d exchange_db; do
          echo "Waiting for postgres..."
          sleep 2
        done
        echo "âœ“ Postgres is ready"
        
        # Initialize database
        echo "Initializing Airflow database..."
        airflow db migrate 2>&1
        
        # Create admin user with environment variables
        echo "Creating admin user (username: $${ADMIN_USERNAME})..."
        airflow users create \
          --username "$${ADMIN_USERNAME}" \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email "$${ADMIN_EMAIL}" \
          --password "$${ADMIN_PASSWORD}" 2>&1 || echo "Admin user already exists"
        
        echo "==================== INIT COMPLETE ===================="
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          ğŸš€ AIRFLOW WEB UI ACCESS                     â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘  URL:      http://localhost:8080                      â•‘"
        echo "â•‘  Username: ${ADMIN_USERNAME}                                  â•‘"
        echo "â•‘  Password: ${ADMIN_PASSWORD}                               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
    restart: "no"

  # Scheduler service
  airflow-scheduler:
    image: quay.io/astronomer/astro-runtime:11.3.0
    container_name: airflow-scheduler
    restart: unless-stopped
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      exchange-postgres:
        condition: service_healthy
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://exchanger:exchanger@exchange-postgres:5432/exchange_db
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "airflow_secret_key_change_in_prod"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "true"
      EXCHANGE_DB_URL: postgresql://exchanger:exchanger@exchange-postgres:5432/exchange_db
    volumes:
      - ./dags:/usr/local/airflow/dags:ro
      - ./etl:/usr/local/airflow/dags/etl:ro
      - ./sql:/usr/local/airflow/dags/sql:ro
      - airflow_logs:/usr/local/airflow/logs
    entrypoint: /bin/bash
    command:
      - -c
      - |
        echo "Starting Airflow Scheduler..."
        exec airflow scheduler
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'airflow scheduler' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Webserver service  
  airflow-webserver:
    image: quay.io/astronomer/astro-runtime:11.3.0
    container_name: airflow-webserver
    restart: unless-stopped
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      exchange-postgres:
        condition: service_healthy
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://exchanger:exchanger@exchange-postgres:5432/exchange_db
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "airflow_secret_key_change_in_prod"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "true"
      EXCHANGE_DB_URL: postgresql://exchanger:exchanger@exchange-postgres:5432/exchange_db
    ports:
      - "8080:8080"
    volumes:
      - ./dags:/usr/local/airflow/dags:ro
      - ./etl:/usr/local/airflow/dags/etl:ro
      - ./sql:/usr/local/airflow/dags/sql:ro  
      - airflow_logs:/usr/local/airflow/logs
    entrypoint: /bin/bash
    command:
      - -c
      - |
        echo "Starting Airflow Webserver..."
        exec airflow webserver
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'airflow webserver' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Streamlit service - runs conditionally based on DAG completion
   # Streamlit service - runs after DAG completion
  streamlit:
    build:
      context: ./streamlit_app
      dockerfile: Dockerfile
    container_name: streamlit
    restart: unless-stopped
    depends_on:
      exchange-postgres:
        condition: service_healthy
    volumes:
      - ./streamlit_app:/app   # optional; keep for live edits
    environment:
      EXCHANGE_DB_URL: postgresql://exchanger:exchanger@exchange-postgres:5432/exchange_db
      AIRFLOW_DB_URL: postgresql://exchanger:exchanger@exchange-postgres:5432/exchange_db
      STREAMLIT_USERNAME: streamlit_user
      STREAMLIT_PASSWORD: streamlit123
      WAIT_FOR_DAG: "yes"
      MAX_WAIT: "300"           # optional: shorten wait for dev
      SLEEP_INTERVAL: "6"
    ports:
      - "8501:8501"
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport socket,sys\ns=socket.socket(); s.settimeout(2)\ntry: s.connect(('127.0.0.1',8501)); print('OK')\nexcept Exception as e: print('ERR',e); sys.exit(1)\nfinally: s.close()\nPY"]
      interval: 30s
      timeout: 5s
      retries: 6
      start_period: 30s



volumes:
  postgres_data:
  airflow_logs: